import{d as e,e as t,c as a,f as s,r as o}from"../../../_/nitro.mjs";import{u as r}from"../../../_/supabase.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@iconify/utils";import"node:crypto";import"consola";import"node:url";import"ipx";import"node:fs";import"node:path";import"@supabase/supabase-js";const i=e((async e=>{const i=t(e),n=r(),d=e.context.user;if(!d)throw a({statusCode:401,statusMessage:"Unauthorized"});switch(i){case"GET":{const{data:e,error:t}=await n.from("bot_credentials").select("*").eq("user_id",d.id).order("label",{ascending:!0});if(t)throw a({statusCode:500,statusMessage:"Failed to load bot credentials",data:t.message});return{data:e}}case"POST":{const t=await o(e);if(!(null==t?void 0:t.exchange))throw a({statusCode:400,statusMessage:"Exchange is required"});const s=function(e){const t="webhook"===e.exchange?"TradingView Webhook":`${e.exchange.toUpperCase()} Account`;return{exchange:e.exchange,fields:{label:e.label||t,environment:e.environment||"production",account_id:e.accountId||null,api_key:e.apiKey||null,api_secret:e.apiSecret||null,passphrase:e.passphrase||null,webhook_secret:e.webhookSecret||null,extra_metadata:e.extraMetadata||{}}}}(t),{data:r}=await n.from("bot_credentials").select("*").eq("exchange",s.exchange).eq("user_id",d.id).maybeSingle();let i;if(r){const{data:e,error:t}=await n.from("bot_credentials").update({...s.fields,updated_at:(new Date).toISOString()}).eq("id",r.id).eq("user_id",d.id).select().single();if(t)throw a({statusCode:500,statusMessage:"Failed to update credential",data:t.message});i=e}else{const{data:e,error:t}=await n.from("bot_credentials").insert({exchange:s.exchange,user_id:d.id,...s.fields}).select().single();if(t)throw a({statusCode:500,statusMessage:"Failed to create credential",data:t.message});i=e}return{success:!0,credential:i}}case"DELETE":{const t=s(e),o="string"==typeof t.exchange?t.exchange:null;if(!o)throw a({statusCode:400,statusMessage:"Exchange query parameter is required"});const{error:r}=await n.from("bot_credentials").delete().eq("exchange",o).eq("user_id",d.id);if(r)throw a({statusCode:500,statusMessage:"Failed to delete credential",data:r.message});return{success:!0}}default:throw a({statusCode:405,statusMessage:"Method Not Allowed"})}}));export{i as default};
//# sourceMappingURL=index.mjs.map
