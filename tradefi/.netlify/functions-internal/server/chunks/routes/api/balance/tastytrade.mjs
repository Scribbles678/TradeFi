import{d as e,c as a}from"../../../_/nitro.mjs";import{s as r}from"../../../_/serverSupabaseClient.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@iconify/utils";import"node:crypto";import"consola";import"node:url";import"ipx";import"node:fs";import"node:path";import"@supabase/ssr";const t=e((async e=>{var t;if(!e.context.user)throw a({statusCode:401,message:"Unauthorized - Please log in"});const s=await r(e),{data:n,error:o}=await s.from("bot_credentials").select("api_key, api_secret, account_id, username, password").eq("exchange","tastytrade").single();if(o||!n)return{success:!1,exchange:"Tasty Trade",error:"Tasty Trade credentials not configured",disabled:!0};n.api_key,n.api_secret,n.username,n.password;const i=n.account_id;try{const e=await $fetch("/api/auth/tastytrade-token");if(!e.success)return e.disabled?{success:!1,exchange:"Tasty Trade",error:"Tasty Trade is disabled",disabled:!0}:{success:!1,exchange:"Tasty Trade",error:`OAuth2 token failed: ${e.error}`};const a=e.access_token,r=await $fetch(`https://api.tastytrade.com/accounts/${i}`,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}});if(console.log("Tasty Trade API Response:",r),!(null==(t=null==r?void 0:r.data)?void 0:t.account))return{success:!1,exchange:"Tasty Trade",error:"Invalid response from Tasty Trade API"};const s=r.data.account,n=s.net_liquidation_value||s.total_equity||0,o=s.available_funds||0,u=s.buying_power||0,c=s.long_futures_value||0,d=s.short_futures_value||0;return{success:!0,exchange:"Tasty Trade",balance:n,availableFunds:o,buyingPower:u,longFuturesValue:c,shortFuturesValue:d,futuresMarginRequirement:s.futures_margin_requirement||0,dayTradeBuyingPower:s.day_trade_buying_power||0,overnightBuyingPower:s.overnight_buying_power||0,marginEquity:s.margin_equity||0,maintenanceRequirement:s.maintenance_requirement||0}}catch(e){const a=e instanceof Error?e.message:"Unknown error occurred",r=a.includes("401")||a.includes("Unauthorized");return r||console.error("Tasty Trade balance error:",e),{success:!1,exchange:"Tasty Trade",error:r?"Tasty Trade is disabled (invalid credentials)":a,disabled:!0}}}));export{t as default};
//# sourceMappingURL=tastytrade.mjs.map
