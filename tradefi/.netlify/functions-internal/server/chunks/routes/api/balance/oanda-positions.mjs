import{d as n,a as o}from"../../../_/nitro.mjs";import"node:http";import"node:https";import"node:events";import"node:buffer";import"@iconify/utils";import"node:crypto";import"consola";import"node:url";import"ipx";import"node:fs";import"node:path";const e=n((async n=>{const e=o(),t=e.oandaApiKey,r=e.oandaBaseUrl;try{const n=e.oandaAccountId;if(!n)throw new Error("OANDA Account ID not configured");const o=r.endsWith("/")?r.slice(0,-1):r,i=await $fetch(`${o}/v3/accounts/${n}/openPositions`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});console.log("OANDA Open Positions API Response:",i);const s=(null==i?void 0:i.positions)||[];console.log("OANDA Active Positions:",s.length);const a=s.map((n=>n.instrument));let l={};if(a.length>0)try{const e=a.join(","),r=await $fetch(`${o}/v3/accounts/${n}/pricing?instruments=${encodeURIComponent(e)}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});console.log("OANDA Pricing API Response:",r),(null==r?void 0:r.prices)&&r.prices.forEach((n=>{var o,e,t,r;const i=parseFloat((null==(e=null==(o=n.bids)?void 0:o[0])?void 0:e.price)||"0"),s=parseFloat((null==(r=null==(t=n.asks)?void 0:t[0])?void 0:r.price)||"0");i>0&&s>0?l[n.instrument]=(i+s)/2:i>0?l[n.instrument]=i:s>0&&(l[n.instrument]=s)})),console.log("OANDA Pricing Data:",l)}catch(n){console.error("Error fetching OANDA pricing (will calculate from P&L):",n),console.error("Pricing error details:",n instanceof Error?n.message:String(n))}const c=s.map((o=>{var e,t,r,i,s,a,c,u;const p=parseFloat((null==(e=o.long)?void 0:e.units)||"0"),d=parseFloat((null==(t=o.short)?void 0:t.units)||"0"),m=p>0,g=m?p:Math.abs(d),A=m?"BUY":"SELL",h=parseFloat(m?(null==(r=o.long)?void 0:r.averagePrice)||"0":(null==(i=o.short)?void 0:i.averagePrice)||"0"),P=parseFloat(m?(null==(s=o.long)?void 0:s.unrealizedPL)||"0":(null==(a=o.short)?void 0:a.unrealizedPL)||"0");console.log(`OANDA Position ${o.instrument}:`,{side:A,units:g,entryPrice:h,unrealizedPnl:P,longData:o.long,shortData:o.short});let v=l[o.instrument];!v&&g>0&&h>0&&(v=m?h+P/g:h-P/g),(!v||v<=0||isNaN(v))&&(v=h);const f=Math.abs(g*h),D=f>0?P/f*100:0;return console.log(`OANDA Position ${o.instrument} formatted:`,{symbol:o.instrument,side:A,entryPrice:h,currentPrice:v,units:g,positionSizeUsd:f,unrealizedPnl:P,unrealizedPnlPercent:D}),{id:`${o.instrument}_${A}_${n}`,symbol:o.instrument,side:A,entry_price:h,current_price:v,quantity:g,position_size_usd:f,unrealized_pnl_usd:P,unrealized_pnl_percent:D,entry_time:(null==(u=null==(c=o.long)?void 0:c.tradeIDs)||u[0],(new Date).toISOString()),exchange:"oanda",asset_class:"forex"}}));return{success:!0,exchange:"OANDA",positions:c,count:c.length}}catch(n){return console.error("OANDA Positions API Error:",n),{success:!1,exchange:"OANDA",positions:[],count:0,error:n instanceof Error?n.message:String(n)}}}));export{e as default};
//# sourceMappingURL=oanda-positions.mjs.map
