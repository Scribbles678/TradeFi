import{createClient as e}from"@supabase/supabase-js";import{g as t}from"./server.mjs";let s=null;function useSupabaseClient(){if(s)return s;const a=t(),r=a.public.supabaseUrl,n=a.public.supabaseKey;return function(e,t){if(!e||!t)throw new Error("Supabase environment variables are missing. Ensure SUPABASE_URL and SUPABASE_ANON_KEY are set.")}(r,n),s=e(r,n),s}async function getOpenPositions(e){let t=useSupabaseClient().from("positions").select("*");e&&(t=t.eq("asset_class",e));const{data:s,error:a}=await t.order("created_at",{ascending:!1});return console.log("Supabase Positions Query:",{assetClass:e,dataCount:(null==s?void 0:s.length)||0,error:(null==a?void 0:a.message)||"none"}),a?(console.error("Error fetching positions:",a),[]):s||[]}async function getRecentTrades(e=20,t){let s=useSupabaseClient().from("trades").select("*");t&&(s=s.eq("asset_class",t));const{data:a,error:r}=await s.order("exit_time",{ascending:!1}).limit(e);return r?(console.error("Error fetching trades:",r),[]):a||[]}async function getCumulativePnL(e=30,t){var s;const a=new Date;a.setDate(a.getDate()-e),console.log("Supabase: Fetching cumulative P&L for",e,"days",t?`(filter: ${t})`:"(all asset classes)"),console.log("Supabase: Start date:",a.toISOString());let r=useSupabaseClient().from("trades").select("exit_time, pnl_usd, symbol, asset_class, exchange").gte("exit_time",a.toISOString());t&&(r=r.eq("asset_class",t),console.log("Supabase: Filtering by asset_class:",t));const{data:n,error:o}=await r.order("exit_time",{ascending:!0});if(o)return console.error("Supabase: Error fetching cumulative P&L:",o),[];if(console.log("Supabase: Found",(null==n?void 0:n.length)||0,"trades in the last",e,"days"),n&&n.length>0&&console.log("Supabase: Trades data:",n.map((e=>({symbol:e.symbol,exit_time:e.exit_time,pnl_usd:e.pnl_usd,asset_class:e.asset_class,exchange:e.exchange})))),!n||0===n.length)return console.log("Supabase: No trades found - chart will show empty state"),[];let i=0;const l=n.map((e=>(i+=e.pnl_usd||0,{date:new Date(e.exit_time).toLocaleDateString(),cumulative_pnl:parseFloat(i.toFixed(2))})));return console.log("Supabase: Cumulative P&L result:",l),console.log("Supabase: Final cumulative P&L:",null==(s=l[l.length-1])?void 0:s.cumulative_pnl),l}async function getTodaysStats(e){const t=await async function(e){const t=new Date;t.setHours(0,0,0,0);let s=useSupabaseClient().from("trades").select("*").gte("exit_time",t.toISOString());e&&(s=s.eq("asset_class",e));const{data:a,error:r}=await s.order("exit_time",{ascending:!1});return r?(console.error("Error fetching today's trades:",r),[]):a||[]}(e);if(0===t.length)return{todayPnL:0,winRate:0,totalTrades:0};console.log("Supabase: Today's trades for stats:",t.map((e=>({id:e.id,symbol:e.symbol,pnl_usd:e.pnl_usd,entry_price:e.entry_price,exit_price:e.exit_price,quantity:e.quantity,side:e.side,exchange:e.exchange,asset_class:e.asset_class,position_size_usd:e.position_size_usd,exit_time:e.exit_time,notes:e.notes}))));const s=t.filter((e=>Math.abs(e.pnl_usd||0)>1e3));s.length>0&&console.warn("Supabase: Found trades with suspiciously large P&L values:",s.map((e=>({id:e.id,symbol:e.symbol,pnl_usd:e.pnl_usd,entry_price:e.entry_price,exit_price:e.exit_price,quantity:e.quantity,position_size_usd:e.position_size_usd,exchange:e.exchange,notes:e.notes,calculated_pnl:e.entry_price&&e.exit_price&&e.quantity?"BUY"===e.side?(e.exit_price-e.entry_price)*e.quantity:(e.entry_price-e.exit_price)*e.quantity:"N/A"}))));const a=t.reduce(((e,t)=>{const s=t.pnl_usd||0;return console.log(`Supabase: Adding trade ${t.symbol} P&L: $${s} (total so far: ${e+s})`),e+s}),0),r=t.filter((e=>e.is_winner)).length,n=r/t.length*100;return console.log("Supabase: Today's stats calculated:",{todayPnL:a,winRate:n,totalTrades:t.length,winners:r}),{todayPnL:parseFloat(a.toFixed(2)),winRate:parseFloat(n.toFixed(2)),totalTrades:t.length}}async function getStrategies(e){let t=useSupabaseClient().from("strategies").select("*");const{data:s,error:a}=await t.order("created_at",{ascending:!1});return a?(console.error("Error fetching strategies:",a),[]):s||[]}async function createStrategy(e){const t=useSupabaseClient(),{data:s,error:a}=await t.from("strategies").insert([e]).select().single();return a?(console.error("Error creating strategy:",a),null):s}async function updateStrategy(e,t){const s=useSupabaseClient(),{data:a,error:r}=await s.from("strategies").update(t).eq("id",e).select().single();return r?(console.error("Error updating strategy:",r),null):a}async function deleteStrategy(e){console.log("Deleting strategy with ID:",e);const t=useSupabaseClient(),{data:s,error:a}=await t.from("strategies").delete().eq("id",e).select();return a?(console.error("Error deleting strategy:",a),console.error("Error details:",{message:a.message,details:a.details,hint:a.hint,code:a.code}),!1):(console.log("Strategy deleted successfully:",s),!0)}async function getStrategyPnL(e){const t=useSupabaseClient(),{data:s,error:a}=await t.from("trades").select("pnl_usd").eq("strategy_id",e);if(a)return console.error("Error fetching strategy P&L:",a),0;if(!s||0===s.length)return 0;const r=s.reduce(((e,t)=>e+(t.pnl_usd||0)),0);return parseFloat(r.toFixed(2))}async function toggleStrategyStatus(e){const t=await async function(e){const t=useSupabaseClient(),{data:s,error:a}=await t.from("strategies").select("*").eq("id",e).single();return a?(console.error("Error fetching strategy:",a),null):s}(e);if(!t)return null;const s="active"===t.status?"inactive":"active";return await updateStrategy(e,{status:s})}export{getOpenPositions as a,getRecentTrades as b,getTodaysStats as c,createStrategy as d,deleteStrategy as e,getStrategies as f,getCumulativePnL as g,getStrategyPnL as h,useSupabaseClient as i,toggleStrategyStatus as t,updateStrategy as u};
//# sourceMappingURL=supabase.mjs.map
